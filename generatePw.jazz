inline fn rng(stack u64 state, stack u64 range) -> stack u64 {
    stack u64 rand_number;
    reg u64 a, c, tmp1, tmp2;
    inline int x, modulo;
    a = 5;
    c = 1;
    tmp1 = state;
    tmp2 = a * tmp1;
    tmp2 = tmp2 + c;
    x = (int) tmp2;
    tmp1 = range;
    modulo = tmp1;
    rand_number = x % modulo;            //FIXED 4
    return rand_number;
}

inline fn random_char_generator(stack u64 state, stack u64 range, stack u64[76] set) -> reg u64, stack u64 {
    reg u64 rand_char;
    stack u64 rand_number;
    rand_number = rng(state, range);
    rand_char = set[(int)rand_number];
    return rand_char, rand_number;
}

export fn generatePw(reg u64 length, reg u64 lowercase_bool, reg u64 uppercase_bool, reg u64 numbers_bool, reg u64 special_bool, reg u64 p_output) {
    // General purpose register
    reg u64 tmp;
    // State of the RNG
    stack u64 state;
    // Size of the set of chars (max index)
    stack u64 max_char;
    // Registers used for iterations
    reg u64 i;
    reg u64 i_set;
    // Stack positions that store the char sets
    stack u64[76] set_of_chars;
    stack u64[26] lowercase_set;
    stack u64[26] uppercase_set;
    stack u64[10] numbers_set;
    stack u64[15] special_set;

    /////////////////////////////////      Sets of characters     ////////////////////////////////////
    //                                                                                              //
    //  Lowercase: {a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r, s, t, u, v, w, x, y, z}   //
    //  Uppercase: {A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z}   //
    //  Numbers: {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}                                                     //
    //  Special Characters: {!, ?, #, $, %, &, +, -, *, _, @, :, ;, =}                              //
    //                                                                                              //
    //////////////////////////////////////////////////////////////////////////////////////////////////

    // Initialize the sets. The values are the ASCII codes of the different characters
    lowercase_set[0] = 97;
    lowercase_set[1] = 98;
    lowercase_set[2] = 99;
    lowercase_set[3] = 100;
    lowercase_set[4] = 101;
    lowercase_set[5] = 102;
    lowercase_set[6] = 103;
    lowercase_set[7] = 104;
    lowercase_set[8] = 105;
    lowercase_set[9] = 106;
    lowercase_set[10] = 107;
    lowercase_set[11] = 108;
    lowercase_set[12] = 109;
    lowercase_set[13] = 110;
    lowercase_set[14] = 111;
    lowercase_set[15] = 112;
    lowercase_set[16] = 113;
    lowercase_set[17] = 114;
    lowercase_set[18] = 115;
    lowercase_set[19] = 116;
    lowercase_set[20] = 117;
    lowercase_set[21] = 118;
    lowercase_set[22] = 119;
    lowercase_set[23] = 120;
    lowercase_set[24] = 121;
    lowercase_set[25] = 122;
    uppercase_set[0] = 65;
    uppercase_set[1] = 66;
    uppercase_set[2] = 67;
    uppercase_set[3] = 68;
    uppercase_set[4] = 69;
    uppercase_set[5] = 70;
    uppercase_set[6] = 71;
    uppercase_set[7] = 72;
    uppercase_set[8] = 73;
    uppercase_set[9] = 74;
    uppercase_set[10] = 75;
    uppercase_set[11] = 76;
    uppercase_set[12] = 77;
    uppercase_set[13] = 78;
    uppercase_set[14] = 79;
    uppercase_set[15] = 80;
    uppercase_set[16] = 81;
    uppercase_set[17] = 82;
    uppercase_set[18] = 83;
    uppercase_set[19] = 84;
    uppercase_set[20] = 85;
    uppercase_set[21] = 86;
    uppercase_set[22] = 87;
    uppercase_set[23] = 88;
    uppercase_set[24] = 89;
    uppercase_set[25] = 90;
    numbers_set[0] = 48;
    numbers_set[1] = 49;
    numbers_set[2] = 50;
    numbers_set[3] = 51;
    numbers_set[4] = 52;
    numbers_set[5] = 53;
    numbers_set[6] = 54;
    numbers_set[7] = 55;
    numbers_set[8] = 56;
    numbers_set[9] = 57;
    special_set[0] = 33;
    special_set[1] = 63;
    special_set[2] = 35;
    special_set[3] = 36;
    special_set[4] = 37;
    special_set[5] = 38;
    special_set[6] = 43;
    special_set[7] = 45;
    special_set[8] = 42;
    special_set[9] = 95;
    special_set[10] = 64;
    special_set[11] = 58;
    special_set[12] = 59;
    special_set[13] = 61;

    i = 0;
    while (i < 76) {
        set_of_chars[(int)i] = 0;
        i += 1;
    }    

    // Initialize the set of characters according to user policies
    i_set = 0;
    if (lowercase_bool == 1) {
        i = 0;
        while (i < 26) {
            tmp = lowercase_set[(int)i];
            set_of_chars[(int)i_set] = tmp;
            i += 1;
            i_set += 1;
        }    
    }
    if (uppercase_bool == 1) {
        i = 0;
        while (i < 26) {
            tmp = uppercase_set[(int)i];
            set_of_chars[(int)i_set] = tmp;
            i += 1;
            i_set += 1;
        }    
    }
    if (numbers_bool == 1) {
        i = 0;
        while (i < 10) {
            tmp = numbers_set[(int)i];
            set_of_chars[(int)i_set] = tmp;
            i += 1;
            i_set += 1;
        }    
    }
    if (special_bool == 1) {
        i = 0;
        while (i < 14) {
            tmp = special_set[(int)i];
            set_of_chars[(int)i_set] = tmp;
            i += 1;
            i_set += 1;
        }    
    }

    // Generate password from the set of characters available
    tmp = 26 * lowercase_bool + 26 * uppercase_bool + 10 * numbers_bool + 14 * special_bool;
    max_char = 1;
    i = 0;
    state = length;
    while (i < length) {
        tmp, state = random_char_generator(state, max_char, set_of_chars);
        [p_output + i] = tmp;
        i += 1;
    }

    // Make sure last character is \0
    [p_output + length] = 0;
}